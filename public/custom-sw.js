const CACHE_NAME = "offline-cache-v1";
const OFFLINE_URL = "/offline";
const ICON_URL = "/icon-144.png";
const FAVICON_URL = "/favicon.ico"
const TILES_PATH = "/tiles/";
const MANIFEST_URL = "/manifest.json";

const FILES_TO_CACHE = [
  OFFLINE_URL,
  ICON_URL,
  FAVICON_URL,
  MANIFEST_URL,
];

// Función para agregar dinámicamente las tiles al cache
const cacheTiles = async (cache) => {
  // Lista de archivos disponibles
  const availableTiles = [
    '12_917_1820.png', '12_917_1821.png', '12_917_1822.png', '12_917_1823.png',
    '12_917_1824.png', '12_917_1825.png', '12_918_1820.png', '12_918_1821.png',
    '12_918_1822.png', '12_918_1823.png', '12_918_1824.png', '12_918_1825.png',
    '12_919_1820.png', '12_919_1821.png', '12_919_1822.png', '12_919_1823.png',
    '12_919_1824.png', '12_919_1825.png', '12_920_1820.png', '12_920_1821.png',
    '12_920_1822.png', '12_920_1823.png', '12_920_1824.png', '12_920_1825.png',
    '12_921_1820.png', '12_921_1821.png', '12_921_1822.png', '12_921_1823.png',
    '12_921_1824.png', '12_921_1825.png', '12_922_1820.png', '12_922_1821.png',
    '12_922_1822.png', '12_922_1823.png', '12_922_1824.png', '12_922_1825.png',
    '13_1835_3641.png', '13_1835_3642.png', '13_1835_3643.png', '13_1835_3644.png',
    '13_1835_3645.png', '13_1835_3646.png', '13_1835_3647.png', '13_1835_3648.png',
    '13_1835_3649.png', '13_1835_3650.png', '13_1835_3651.png', '13_1836_3641.png',
    '13_1836_3642.png', '13_1836_3643.png', '13_1836_3644.png', '13_1836_3645.png',
    '13_1836_3646.png', '13_1836_3647.png', '13_1836_3648.png', '13_1836_3649.png',
    '13_1836_3650.png', '13_1836_3651.png', '13_1837_3641.png', '13_1837_3642.png',
    '13_1837_3643.png', '13_1837_3644.png', '13_1837_3645.png', '13_1837_3646.png',
    '13_1837_3647.png', '13_1837_3648.png', '13_1837_3649.png', '13_1837_3650.png',
    '13_1837_3651.png', '13_1838_3641.png', '13_1838_3642.png', '13_1838_3643.png',
    '13_1838_3644.png', '13_1838_3645.png', '13_1838_3646.png', '13_1838_3647.png',
    '13_1838_3648.png', '13_1838_3649.png', '13_1838_3650.png', '13_1838_3651.png',
    '13_1839_3641.png', '13_1839_3642.png', '13_1839_3643.png', '13_1839_3644.png',
    '13_1839_3645.png', '13_1839_3646.png', '13_1839_3647.png', '13_1839_3648.png',
    '13_1839_3649.png', '13_1839_3650.png', '13_1839_3651.png', '13_1840_3641.png',
    '13_1840_3642.png', '13_1840_3643.png', '13_1840_3644.png', '13_1840_3645.png',
    '13_1840_3646.png', '13_1840_3647.png', '13_1840_3648.png', '13_1840_3649.png',
    '13_1840_3650.png', '13_1840_3651.png', '13_1841_3641.png', '13_1841_3642.png',
    '13_1841_3643.png', '13_1841_3644.png', '13_1841_3645.png', '13_1841_3646.png',
    '13_1841_3647.png', '13_1841_3648.png', '13_1841_3649.png', '13_1841_3650.png',
    '13_1841_3651.png', '13_1842_3641.png', '13_1842_3642.png', '13_1842_3643.png',
    '13_1842_3644.png', '13_1842_3645.png', '13_1842_3646.png', '13_1842_3647.png',
    '13_1842_3648.png', '13_1842_3649.png', '13_1842_3650.png', '13_1842_3651.png',
    '13_1843_3641.png', '13_1843_3642.png', '13_1843_3643.png', '13_1843_3644.png',
    '13_1843_3645.png', '13_1843_3646.png', '13_1843_3647.png', '13_1843_3648.png',
    '13_1843_3649.png', '13_1843_3650.png', '13_1843_3651.png', '13_1844_3641.png',
    '13_1844_3642.png', '13_1844_3643.png', '13_1844_3644.png', '13_1844_3645.png',
    '13_1844_3646.png', '13_1844_3647.png', '13_1844_3648.png', '13_1844_3649.png',
    '13_1844_3650.png', '13_1844_3651.png', '14_3670_7282.png', '14_3670_7283.png',
    '14_3670_7284.png', '14_3670_7285.png', '14_3670_7286.png', '14_3670_7287.png',
    '14_3670_7288.png', '14_3670_7289.png', '14_3670_7290.png', '14_3670_7291.png',
    '14_3670_7292.png', '14_3670_7293.png', '14_3670_7294.png', '14_3670_7295.png',
    '14_3670_7296.png', '14_3670_7297.png', '14_3670_7298.png', '14_3670_7299.png',
    '14_3670_7300.png', '14_3670_7301.png', '14_3670_7302.png', '14_3670_7303.png',
    '14_3671_7282.png', '14_3671_7283.png', '14_3671_7284.png', '14_3671_7285.png',
    '14_3671_7286.png', '14_3671_7287.png', '14_3671_7288.png', '14_3671_7289.png',
    '14_3671_7290.png', '14_3671_7291.png', '14_3671_7292.png', '14_3671_7293.png',
    '14_3671_7294.png', '14_3671_7295.png', '14_3671_7296.png', '14_3671_7297.png',
    '14_3671_7298.png', '14_3671_7299.png', '14_3671_7300.png', '14_3671_7301.png',
    '14_3671_7302.png', '14_3671_7303.png', '14_3672_7282.png', '14_3672_7283.png',
    '14_3672_7284.png', '14_3672_7285.png', '14_3672_7286.png', '14_3672_7287.png',
    '14_3672_7288.png', '14_3672_7289.png', '14_3672_7290.png', '14_3672_7291.png',
    '14_3672_7292.png', '14_3672_7293.png', '14_3672_7294.png', '14_3672_7295.png',
    '14_3672_7296.png', '14_3672_7297.png', '14_3672_7298.png', '14_3672_7299.png',
    '14_3672_7300.png', '14_3672_7301.png', '14_3672_7302.png', '14_3672_7303.png',
    '14_3673_7282.png', '14_3673_7283.png', '14_3673_7284.png', '14_3673_7285.png',
    '14_3673_7286.png', '14_3673_7287.png', '14_3673_7288.png', '14_3673_7289.png',
    '14_3673_7290.png', '14_3673_7291.png', '14_3673_7292.png', '14_3673_7293.png',
    '14_3673_7294.png', '14_3673_7295.png', '14_3673_7296.png', '14_3673_7297.png',
    '14_3673_7298.png', '14_3673_7299.png', '14_3673_7300.png', '14_3673_7301.png',
    '14_3673_7302.png', '14_3673_7303.png', '14_3674_7282.png', '14_3674_7283.png',
    '14_3674_7284.png', '14_3674_7285.png', '14_3674_7286.png', '14_3674_7287.png',
    '14_3674_7288.png', '14_3674_7289.png', '14_3674_7290.png', '14_3674_7291.png',
    '14_3674_7292.png', '14_3674_7293.png', '14_3674_7294.png', '14_3674_7295.png',
    '14_3674_7296.png', '14_3674_7297.png', '14_3674_7298.png', '14_3674_7299.png',
    '14_3674_7300.png', '14_3674_7301.png', '14_3674_7302.png', '14_3674_7303.png',
    '14_3675_7282.png', '14_3675_7283.png', '14_3675_7284.png', '14_3675_7285.png',
    '14_3675_7286.png', '14_3675_7287.png', '14_3675_7288.png', '14_3675_7289.png',
    '14_3675_7290.png', '14_3675_7291.png', '14_3675_7292.png', '14_3675_7293.png',
    '14_3675_7294.png', '14_3675_7295.png', '14_3675_7296.png', '14_3675_7297.png',
    '14_3675_7298.png', '14_3675_7299.png', '14_3675_7300.png', '14_3675_7301.png',
    '14_3675_7302.png', '14_3675_7303.png', '14_3676_7282.png', '14_3676_7283.png',
    '14_3676_7284.png', '14_3676_7285.png', '14_3676_7286.png', '14_3676_7287.png',
    '14_3676_7288.png', '14_3676_7289.png', '14_3676_7290.png', '14_3676_7291.png',
    '14_3676_7292.png', '14_3676_7293.png', '14_3676_7294.png', '14_3676_7295.png',
    '14_3676_7296.png', '14_3676_7297.png', '14_3676_7298.png', '14_3676_7299.png',
    '14_3676_7300.png', '14_3676_7301.png', '14_3676_7302.png', '14_3676_7303.png',
    '14_3677_7282.png', '14_3677_7283.png', '14_3677_7284.png', '14_3677_7285.png',
    '14_3677_7286.png', '14_3677_7287.png', '14_3677_7288.png', '14_3677_7289.png',
    '14_3677_7290.png', '14_3677_7291.png', '14_3677_7292.png', '14_3677_7293.png',
    '14_3677_7294.png', '14_3677_7295.png', '14_3677_7296.png', '14_3677_7297.png',
    '14_3677_7298.png', '14_3677_7299.png', '14_3677_7300.png', '14_3677_7301.png',
    '14_3677_7302.png', '14_3677_7303.png', '14_3678_7282.png', '14_3678_7283.png',
    '14_3678_7284.png', '14_3678_7285.png', '14_3678_7286.png', '14_3678_7287.png',
    '14_3678_7288.png', '14_3678_7289.png', '14_3678_7290.png', '14_3678_7291.png',
    '14_3678_7292.png', '14_3678_7293.png', '14_3678_7294.png', '14_3678_7295.png',
    '14_3678_7296.png', '14_3678_7297.png', '14_3678_7298.png', '14_3678_7299.png',
    '14_3678_7300.png', '14_3678_7301.png', '14_3678_7302.png', '14_3678_7303.png',
    '14_3679_7282.png', '14_3679_7283.png', '14_3679_7284.png', '14_3679_7285.png',
    '14_3679_7286.png', '14_3679_7287.png', '14_3679_7288.png', '14_3679_7289.png',
    '14_3679_7290.png', '14_3679_7291.png', '14_3679_7292.png', '14_3679_7293.png',
    '14_3679_7294.png', '14_3679_7295.png', '14_3679_7296.png', '14_3679_7297.png',
    '14_3679_7298.png', '14_3679_7299.png', '14_3679_7300.png', '14_3679_7301.png',
    '14_3679_7302.png', '14_3679_7303.png', '14_3680_7282.png', '14_3680_7283.png',
    '14_3680_7284.png', '14_3680_7285.png', '14_3680_7286.png', '14_3680_7287.png',
    '14_3680_7288.png', '14_3680_7289.png', '14_3680_7290.png', '14_3680_7291.png',
    '14_3680_7292.png', '14_3680_7293.png', '14_3680_7294.png', '14_3680_7295.png',
    '14_3680_7296.png', '14_3680_7297.png', '14_3680_7298.png', '14_3680_7299.png',
    '14_3680_7300.png', '14_3680_7301.png', '14_3680_7302.png', '14_3680_7303.png',
    '14_3681_7282.png', '14_3681_7283.png', '14_3681_7284.png', '14_3681_7285.png',
    '14_3681_7286.png', '14_3681_7287.png', '14_3681_7288.png', '14_3681_7289.png',
    '14_3681_7290.png', '14_3681_7291.png', '14_3681_7292.png', '14_3681_7293.png',
    '14_3681_7294.png', '14_3681_7295.png', '14_3681_7296.png', '14_3681_7297.png',
    '14_3681_7298.png', '14_3681_7299.png', '14_3681_7300.png', '14_3681_7301.png',
    '14_3681_7302.png', '14_3681_7303.png', '14_3682_7282.png', '14_3682_7283.png',
    '14_3682_7284.png', '14_3682_7285.png', '14_3682_7286.png', '14_3682_7287.png',
    '14_3682_7288.png', '14_3682_7289.png', '14_3682_7290.png', '14_3682_7291.png',
    '14_3682_7292.png', '14_3682_7293.png', '14_3682_7294.png', '14_3682_7295.png',
    '14_3682_7296.png', '14_3682_7297.png', '14_3682_7298.png', '14_3682_7299.png',
    '14_3682_7300.png', '14_3682_7301.png', '14_3682_7302.png', '14_3682_7303.png',
    '14_3683_7282.png', '14_3683_7283.png', '14_3683_7284.png', '14_3683_7285.png',
    '14_3683_7286.png', '14_3683_7287.png', '14_3683_7288.png', '14_3683_7289.png',
    '14_3683_7290.png', '14_3683_7291.png', '14_3683_7292.png', '14_3683_7293.png',
    '14_3683_7294.png', '14_3683_7295.png', '14_3683_7296.png', '14_3683_7297.png',
    '14_3683_7298.png', '14_3683_7299.png', '14_3683_7300.png', '14_3683_7301.png',
    '14_3683_7302.png', '14_3683_7303.png', '14_3684_7282.png', '14_3684_7283.png',
    '14_3684_7284.png', '14_3684_7285.png', '14_3684_7286.png', '14_3684_7287.png',
    '14_3684_7288.png', '14_3684_7289.png', '14_3684_7290.png', '14_3684_7291.png',
    '14_3684_7292.png', '14_3684_7293.png', '14_3684_7294.png', '14_3684_7295.png',
    '14_3684_7296.png', '14_3684_7297.png', '14_3684_7298.png', '14_3684_7299.png',
    '14_3684_7300.png', '14_3684_7301.png', '14_3684_7302.png', '14_3684_7303.png',
    '14_3685_7282.png', '14_3685_7283.png', '14_3685_7284.png', '14_3685_7285.png',
    '14_3685_7286.png', '14_3685_7287.png', '14_3685_7288.png', '14_3685_7289.png',
    '14_3685_7290.png', '14_3685_7291.png', '14_3685_7292.png', '14_3685_7293.png',
    '14_3685_7294.png', '14_3685_7295.png', '14_3685_7296.png', '14_3685_7297.png',
    '14_3685_7298.png', '14_3685_7299.png', '14_3685_7300.png', '14_3685_7301.png',
    '14_3685_7302.png', '14_3685_7303.png', '14_3686_7282.png', '14_3686_7283.png',
    '14_3686_7284.png', '14_3686_7285.png', '14_3686_7286.png', '14_3686_7287.png',
    '14_3686_7288.png', '14_3686_7289.png', '14_3686_7290.png', '14_3686_7291.png',
    '14_3686_7292.png', '14_3686_7293.png', '14_3686_7294.png', '14_3686_7295.png',
    '14_3686_7296.png', '14_3686_7297.png', '14_3686_7298.png', '14_3686_7299.png',
    '14_3686_7300.png', '14_3686_7301.png', '14_3686_7302.png', '14_3686_7303.png',
    '14_3687_7282.png', '14_3687_7283.png', '14_3687_7284.png', '14_3687_7285.png',
    '14_3687_7286.png', '14_3687_7287.png', '14_3687_7288.png', '14_3687_7289.png',
    '14_3687_7290.png', '14_3687_7291.png', '14_3687_7292.png', '14_3687_7293.png',
    '14_3687_7294.png', '14_3687_7295.png', '14_3687_7296.png', '14_3687_7297.png',
    '14_3687_7298.png', '14_3687_7299.png', '14_3687_7300.png', '14_3687_7301.png',
    '14_3687_7302.png', '14_3687_7303.png', '14_3688_7282.png', '14_3688_7283.png',
    '14_3688_7284.png', '14_3688_7285.png', '14_3688_7286.png', '14_3688_7287.png',
    '14_3688_7288.png', '14_3688_7289.png', '14_3688_7290.png', '14_3688_7291.png',
    '14_3688_7292.png', '14_3688_7293.png', '14_3688_7294.png', '14_3688_7295.png',
    '14_3688_7296.png', '14_3688_7297.png', '14_3688_7298.png', '14_3688_7299.png',
    '14_3688_7300.png', '14_3688_7301.png', '14_3688_7302.png', '14_3688_7303.png',
    '14_3689_7282.png', '14_3689_7283.png', '14_3689_7284.png', '14_3689_7285.png',
    '14_3689_7286.png', '14_3689_7287.png', '14_3689_7288.png', '14_3689_7289.png',
    '14_3689_7290.png', '14_3689_7291.png', '14_3689_7292.png', '14_3689_7293.png',
    '14_3689_7294.png', '14_3689_7295.png', '14_3689_7296.png', '14_3689_7297.png',
    '14_3689_7298.png', '14_3689_7299.png', '14_3689_7300.png', '14_3689_7301.png',
    '14_3689_7302.png', '14_3689_7303.png',
  ];  

  for (const tile of availableTiles) {
    const tilePath = `${TILES_PATH}${tile}`;
    try {
      await cache.add(tilePath);
    } catch (error) {
      console.warn(`Error al cachear tile: ${tilePath}`, error);
    }
  }
};


self.addEventListener("install", (event) => {
  console.log("Service Worker: Instalando...");

  event.waitUntil(
    caches.open(CACHE_NAME).then(async (cache) => {
      console.log("Service Worker: Cacheando recursos básicos");
      await cache.addAll(FILES_TO_CACHE);
      console.log("Service Worker: Cacheando tiles");
      await cacheTiles(cache);
    }).catch((error) => console.error("Error al precachear recursos:", error))
  );
});

self.addEventListener("activate", (event) => {
  console.log("Service Worker: Activado");

  event.waitUntil(
    caches.keys().then((cacheNames) => {
      return Promise.all(
        cacheNames.map((cache) => {
          if (cache !== CACHE_NAME) {
            console.log(`Service Worker: Eliminando cache antiguo: ${cache}`);
            return caches.delete(cache);
          }
        })
      );
    })
  );

  self.clients.claim();
});

self.addEventListener("fetch", (event) => {
  console.log(`Service Worker: Interceptando solicitud: ${event.request.url}`);


  if (event.request.url.endsWith(ICON_URL)) {
    // Manejar específicamente la imagen del ícono
    event.respondWith(
      caches.match(event.request).then((response) => {
        return response || fetch(event.request).catch(() => {
          console.error("Service Worker: Imagen no disponible en modo offline");
          return caches.match(ICON_URL); // Devuelve la imagen desde el caché
        });
      })
    );
    return;
  }

  if (event.request.url.includes(TILES_PATH)) {
    // Manejar tiles desde el cache
    event.respondWith(
      caches.match(event.request).then((response) => {
        return response || fetch(event.request).then((networkResponse) => {
          return caches.open(CACHE_NAME).then((cache) => {
            cache.put(event.request, networkResponse.clone());
            return networkResponse;
          });
        });
      }).catch((error) => {
        console.error("Error al obtener tiles:", error);
      })
    );
  } else if (event.request.mode === "navigate") {
    // Manejar navegación offline
    event.respondWith(
      fetch(event.request).catch(() => {
        console.log("Service Worker: Usuario offline, devolviendo página offline");
        return caches.match(OFFLINE_URL);
      })
    );
  }
});
